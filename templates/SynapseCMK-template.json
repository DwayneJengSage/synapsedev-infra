{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "The master encryption key used to encypt/decypt all Synapse mater secrets",
	"Parameters": {
                "ArnsAllowedToDecrypt": {
                        "Description": "The arns of the users allowed to decrypt.",
                        "Type": "CommaDelimitedList"
				},
				"Stack": {
					"Description": "The stack",
					"Type": "String"
				}
        },
	"Resources": {
		"SynapseCMK": {
			"Type": "AWS::KMS::Key",
			"Properties": {
				"Description": "The master encryption key used to encypt/decypt all Synapse mater secrets",
				"EnableKeyRotation": false,
				"KeyPolicy": {
					"Version": "2012-10-17",
					"Id": "key-default-1",
					"Statement": [
						{
							"Sid": "Allow administration of the key",
							"Effect": "Allow",
							"Principal": {
								"AWS": {
									"Fn::Join": [
										"",
										[
											"arn:aws:iam::",
											{
												"Ref": "AWS::AccountId"
											},
											":root"
										]
									]
								}
							},
							"Action": [
								"kms:*"
							],
							"Resource": "*"
						},
						{
							"Sid": "Allow use of the key",
							"Effect": "Allow",
							"Principal": {								
								"AWS": {"Ref":"ArnsAllowedToDecrypt"}
							},
							"Action": [
								"kms:Encrypt",
								"kms:Decrypt",
								"kms:ReEncrypt*",
								"kms:DescribeKey"
							],
							"Resource": "*"
						}
					]
				}
			}
		},
		"SynapseCMKAlias": {
			"Type": "AWS::KMS::Alias",
			"Properties": {
				"AliasName": { "Fn::Join" : [ "/", ["alias", {"Ref": "Stack"}, "synapse" ] ] },
				"TargetKeyId": {
					"Ref": "SynapseCMK"
				}
			}
		}
	}
}
